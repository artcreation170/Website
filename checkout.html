<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout - Art and Creation</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 font-sans">
  <header class="bg-white shadow">
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="index.html">
          <img src="logo.jpg" alt="Art and Creation Logo" class="rounded-circle" style="height:48px;width:48px;object-fit:cover;margin-right:8px" loading="lazy">
          <span class="h5 mb-0 text-pink-600">Art and Creation</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar" aria-controls="mainNavbar" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="mainNavbar">
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            <li class="nav-item"><a class="nav-link" href="index.html">Shop</a></li>
            <li class="nav-item"><a class="nav-link" href="checkout.html">Checkout</a></li>
            <li class="nav-item"><a class="nav-link" href="thankyou.html">Orders</a></li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <main class="container mx-auto px-6 py-12">
    <div class="bg-white rounded-lg shadow-lg p-6 max-w-3xl mx-auto">
      <h2 class="text-2xl font-bold mb-4">Checkout</h2>

      <form id="checkoutForm" action="https://formsubmit.co/artcreation170@gmail.com" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="_subject" id="_subject" value="New Order">
        <input type="hidden" name="_next" value="thankyou.html">
        <input type="hidden" name="_captcha" value="false">
        <input type="hidden" name="receipt" id="field_receipt" value="">
        <input type="hidden" name="payment_method" id="field_payment_method" value="RAZORPAY_UPI">
        <input type="hidden" name="payment_status" id="field_payment_status" value="Pending">
        <input type="hidden" name="transaction_id" id="field_transaction_id" value="">
        <input type="hidden" name="product" id="field_product" value="">
        <input type="hidden" name="price" id="field_price" value="">
        <input type="hidden" name="created_at" id="field_created_at" value="">

        <div class="mb-3">
          <label class="form-label font-semibold">Product</label>
          <input id="prodName" name="product_visible" type="text" class="w-full border rounded px-3 py-2" readonly />
        </div>

        <div class="mb-3">
          <label class="form-label font-semibold">Price (INR)</label>
          <input id="prodPrice" name="price_visible" type="text" class="w-full border rounded px-3 py-2" readonly />
        </div>

        <div class="mb-3">
          <label class="form-label font-semibold">Full Name</label>
          <input id="buyerName" name="name" type="text" class="w-full border rounded px-3 py-2" required />
        </div>

        <div class="mb-3">
          <label class="form-label font-semibold">Email</label>
          <input id="buyerEmail" name="email" type="email" class="w-full border rounded px-3 py-2" required />
        </div>

        <div class="mb-3">
          <label class="form-label font-semibold">Phone number</label>
          <input id="buyerPhone" name="phone" type="tel" class="w-full border rounded px-3 py-2" required />
        </div>

        <div class="mb-3">
          <label class="form-label font-semibold">Address</label>
          <textarea id="buyerAddress" name="address" class="w-full border rounded px-3 py-2" rows="3" required></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label font-semibold">Payment screenshot (optional)</label>
          <input id="paymentScreenshot" name="payment_screenshot" type="file" accept="image/*" class="w-full border rounded px-3 py-2" />
          <p class="text-sm text-gray-500 mt-1">If you paid via QR/UPI, upload a screenshot for faster verification.</p>
        </div>

        <div class="mb-3">
          <label class="form-label font-semibold">Transaction ID (if available)</label>
          <input id="qrTxnId" name="qr_txn_id" type="text" class="w-full border rounded px-3 py-2" placeholder="UPI / bank txn id (optional)" />
        </div>

        <div class="mb-4 border-t pt-4">
          <label class="form-label font-semibold">Payment Method</label>
          <div class="mt-2">
            <label class="inline-flex items-center mr-4">
              <input type="radio" name="payment_method_choice" value="RAZORPAY_UPI" id="payUpiRadio" class="form-radio" checked />
              <span class="ml-2">Razorpay UPI (checkout)</span>
            </label>
            <label class="inline-flex items-center">
              <input type="radio" name="payment_method_choice" value="RAZORPAY_QR" id="payQrRadio" class="form-radio" />
              <span class="ml-2">QR (scan)</span>
            </label>
          </div>

          <div id="upiPanel" class="mt-3">
            <div class="mb-2">
              <button id="upiPayBtn" type="button" class="bg-pink-600 text-white px-4 py-2 rounded">Pay via Razorpay (UPI)</button>
              <div id="upiStatus" class="self-center text-sm text-gray-600 inline-block ml-3"></div>
            </div>
            <p class="text-sm text-gray-500">Razorpay Checkout will open. Complete payment to finalize order.</p>
          </div>

          <div id="qrPanel" class="mt-3 hidden">
            <div class="mb-2">
              <button id="generateQrBtn" type="button" class="bg-pink-600 text-white px-4 py-2 rounded">Show QR</button>
              <button id="confirmQrPaidBtn" type="button" class="bg-green-600 text-white px-4 py-2 rounded ml-2">I have paid (confirm)</button>
            </div>
            <div id="qrContainer" class="mt-2">
              <p id="qrStatus" class="text-sm text-gray-600">No QR shown yet.</p>
              <img id="qrImage" src="" alt="QR code" class="mt-2 max-w-xs border rounded hidden" />
            </div>
          </div>

          <input type="hidden" id="_payment_method" name="_payment_method" value="RAZORPAY_UPI">
          <input type="hidden" id="_payment_status" name="_payment_status" value="Pending">
          <input type="hidden" id="_payment_txn" name="_payment_txn" value="">
        </div>

        <div class="flex items-center justify-between">
          <button id="submitBtn" type="submit" class="bg-pink-600 text-white px-4 py-2 rounded">Place Order</button>
          <a href="index.html" class="text-sm text-gray-600">Cancel</a>
        </div>
      </form>

    </div>
  </main>

  <footer class="bg-gray-800 text-white text-center py-6">
    <p>&copy; 2025 Art and Creation. All rights reserved.</p>
  </footer>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const products = [
      { id:1, name:'Mandala Photoframe', price:'499' },
      { id:2, name:'Customized Gift Hamper', price:'399' },
      { id:3, name:'String Art', price:'599' },
      { id:4, name:'Butterfly Keyring', price:'699' },
      { id:5, name:'Customized String Art', price:'450' },
      { id:6, name:'Ganesha Lippan Art', price:'349' },
      { id:7, name:'Dream Catcher Wall Hanging', price:'349' },
      { id:8, name:'Thread Lamp', price:'349' }
    ];

    function getQueryParam(name){ return new URLSearchParams(window.location.search).get(name); }

    function populateCheckout() {
      const id = parseInt(getQueryParam('id')||'1',10);
      const p = products.find(x=>x.id===id)||products[0];
      document.getElementById('prodName').value = p.name;
      document.getElementById('prodPrice').value = p.price;
      document.getElementById('field_product').value = p.name;
      document.getElementById('field_price').value = p.price;
    }

    async function findStaticQrForProduct(product) {
      if(!product) return null;
      const slug = product.toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_\-]/g,'');
      const candidates = [
        `images/qrcodes/${slug}.png`,
        `images/qrcodes/${slug}.jpg`,
        `qrcodes/${slug}.png`,
        `qrcodes/${slug}.jpg`,
        `images/qrcodes/default.png`
      ];
      for(const p of candidates){
        try { const r = await fetch(p,{method:'HEAD'}); if(r.ok) return p;} catch(e){}
      }
      return null;
    }

    function finalizeOrder(orderMeta){
      const receipt='rcpt_'+Date.now();
      const order={
        receipt,
        product:orderMeta.product,
        price:orderMeta.price,
        name:orderMeta.name,
        email:orderMeta.email,
        phone:orderMeta.phone,
        address:orderMeta.address,
        payment_method:document.getElementById('_payment_method').value,
        payment_status:document.getElementById('_payment_status').value,
        payment_txn:document.getElementById('_payment_txn').value,
        created_at: new Date().toISOString()
      };
      localStorage.setItem('lastOrder', JSON.stringify(order));

      // Native form submit to FormSubmit
      (function sendOrderEmailNative(){
        try {
          const endpoint='https://formsubmit.co/artcreation170@gmail.com';
          const f=document.createElement('form');
          f.method='POST'; f.action=endpoint; f.enctype='multipart/form-data'; f.style.display='none';
          f.target='gf_iframe';
          const addHidden=(name,value)=>{ const i=document.createElement('input'); i.type='hidden'; i.name=name; i.value=value||''; f.appendChild(i);}
          addHidden('_subject',`New Order: ${order.product} â€” ${order.name}`);
          addHidden('receipt',order.receipt);
          addHidden('product',order.product);
          addHidden('price',order.price);
          addHidden('name',order.name);
          addHidden('email',order.email||'');
          addHidden('phone',order.phone);
          addHidden('address',order.address);
          addHidden('payment_method',order.payment_method);
          addHidden('payment_status',order.payment_status);
          addHidden('transaction_id',order.payment_txn||'');
          addHidden('created_at',order.created_at);
          addHidden('_next',window.location.origin+'/thankyou.html');
          addHidden('_captcha','false');

          const fileInput=document.getElementById('paymentScreenshot');
          if(fileInput && fileInput.files && fileInput.files.length) f.appendChild(fileInput);

          if(!document.querySelector('iframe[name="gf_iframe"]')){
            const ifr=document.createElement('iframe'); ifr.name='gf_iframe'; ifr.style.display='none'; document.body.appendChild(ifr);
          }

          document.body.appendChild(f); f.submit();
          setTimeout(()=>{ try{ if(fileInput) document.body.appendChild(fileInput); document.body.removeChild(f);} catch(e){} },1500);
        } catch(e){ console.error('Order email submit failed',e);}
      })();
      window.location.href='thankyou.html?receipt='+encodeURIComponent(order.receipt);
    }

    document.addEventListener('DOMContentLoaded',()=>{
      populateCheckout();
      const upiRadio=document.getElementById('payUpiRadio');
      const qrRadio=document.getElementById('payQrRadio');
      const upiPayBtn=document.getElementById('upiPayBtn');
      const genQrBtn=document.getElementById('generateQrBtn');
      const confirmBtn=document.getElementById('confirmQrPaidBtn');

      function setPaymentMethodUI(method){
        const upiPanel=document.getElementById('upiPanel');
        const qrPanel=document.getElementById('qrPanel');
        if(upiPanel) upiPanel.classList.toggle('hidden',method!=='RAZORPAY_UPI');
        if(qrPanel) qrPanel.classList.toggle('hidden',method!=='RAZORPAY_QR');
        document.getElementById('_payment_method').value=method;
        document.getElementById('_payment_status').value='Pending';
        document.getElementById('_payment_txn').value='';
      }

      if(upiRadio) upiRadio.addEventListener('change',()=>setPaymentMethodUI('RAZORPAY_UPI'));
      if(qrRadio) qrRadio.addEventListener('change',()=>setPaymentMethodUI('RAZORPAY_QR'));

      if(genQrBtn) genQrBtn.addEventListener('click',async ()=>{
        const product=document.getElementById('prodName').value||'';
        const qrStatus=document.getElementById('qrStatus');
        const qrImg=document.getElementById('qrImage');
        qrStatus.textContent='Searching for static QR...';
        const path=await findStaticQrForProduct(product);
        if(path){ qrImg.src=path; qrImg.classList.remove('hidden'); qrStatus.textContent='Scan the QR with your UPI app to pay.'; document.getElementById('_payment_status').value='QR Shown';}
        else qrStatus.textContent='No static QR found. Provide a static QR image under images/qrcodes/.';
      });

      if(confirmBtn) confirmBtn.addEventListener('click',()=>{
        const txn=document.getElementById('qrTxnId').value||'';
        const fileInput=document.getElementById('paymentScreenshot');
        const hasFile=fileInput && fileInput.files && fileInput.files[0];
        if(!txn && !hasFile){ alert('Please upload screenshot or enter txn ID before confirming payment.'); return;}
        document.getElementById('_payment_method').value='RAZORPAY_QR';
        document.getElementById('_payment_status').value='Paid (manual-confirm)';
        if(txn) document.getElementById('_payment_txn').value=txn;
        const meta={
          product:document.getElementById('prodName').value,
          price:document.getElementById('prodPrice').value,
          name:document.getElementById('buyerName').value.trim(),
          email:document.getElementById('buyerEmail').value.trim(),
          phone:document.getElementById('buyerPhone').value.trim(),
          address:document.getElementById('buyerAddress').value.trim()
        };
        finalizeOrder(meta);
      });

      document.getElementById('checkoutForm').addEventListener('submit',e=>{
        e.preventDefault();
        const meta={
          product:document.getElementById('prodName').value,
          price:document.getElementById('prodPrice').value,
          name:document.getElementById('buyerName').value.trim(),
          email:document.getElementById('buyerEmail').value.trim(),
          phone:document.getElementById('buyerPhone').value.trim(),
          address:document.getElementById('buyerAddress').value.trim()
        };
        finalizeOrder(meta);
      });

      setPaymentMethodUI('RAZORPAY_UPI');
    });
  </script>
</body>
</html>
