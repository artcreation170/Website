<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout - Art and Creation</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 font-sans">
  <header class="bg-white shadow">
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="index.html">
          <img src="logo.jpg" alt="Art and Creation Logo" class="rounded-circle" style="height:48px;width:48px;object-fit:cover;margin-right:8px" loading="lazy">
          <span class="h5 mb-0 text-pink-600">Art and Creation</span>
        </a>
      </div>
    </nav>
  </header>

  <main class="container mx-auto px-6 py-12">
    <div class="bg-white rounded-lg shadow-lg p-6 max-w-3xl mx-auto">
      <h2 class="text-2xl font-bold mb-6 text-pink-600">Checkout</h2>

      <form id="checkoutForm" action="https://formsubmit.co/artcreation170@gmail.com" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="_subject" value="New Order">
        <input type="hidden" name="_next" value="thankyou.html">
        <input type="hidden" name="_captcha" value="false">
        <input type="hidden" id="_payment_status" name="_payment_status" value="Pending">
        <input type="hidden" id="field_product" name="product" value="">
        <input type="hidden" id="field_price" name="price" value="">

        <!-- Product Info -->
        <div class="mb-3">
          <label class="form-label font-semibold">Product</label>
          <input id="prodName" name="product_visible" type="text" class="w-full border rounded px-3 py-2 bg-gray-100" readonly />
        </div>

        <div class="mb-3">
          <label class="form-label font-semibold">Price (INR)</label>
          <input id="prodPrice" name="price_visible" type="text" class="w-full border rounded px-3 py-2 bg-gray-100" readonly />
        </div>

        <!-- Customer Info -->
        <div class="mb-3">
          <label class="form-label font-semibold">Full Name</label>
          <input id="buyerName" name="name" type="text" class="w-full border rounded px-3 py-2" required placeholder="Enter your full name" />
        </div>

        <div class="mb-3">
          <label class="form-label font-semibold">Email</label>
          <input id="buyerEmail" name="email" type="email" class="w-full border rounded px-3 py-2" required placeholder="Enter your email" />
        </div>

        <div class="mb-3">
          <label class="form-label font-semibold">Phone number</label>
          <input id="buyerPhone" name="phone" type="tel" class="w-full border rounded px-3 py-2" required placeholder="Enter your phone number" />
        </div>

        <div class="mb-3">
          <label class="form-label font-semibold">Address</label>
          <textarea id="buyerAddress" name="address" class="w-full border rounded px-3 py-2" rows="3" required placeholder="Enter your delivery address"></textarea>
        </div>

        <!-- Payment Details -->
        <div class="mb-3">
          <label class="form-label font-semibold">Transaction ID (if available)</label>
          <input id="qrTxnId" name="transaction_id" type="text" class="w-full border rounded px-3 py-2" placeholder="Enter your transaction ID" />
        </div>

        <div class="mb-3">
          <label class="form-label font-semibold">Payment Screenshot</label>
          <input id="paymentScreenshot" name="payment_screenshot" type="file" accept="image/*" class="w-full border rounded px-3 py-2" />
          <p class="text-sm text-gray-500 mt-1">Upload your payment screenshot to verify payment faster.</p>
        </div>

        <!-- QR Payment -->
        <div class="mb-4 border-t pt-4">
          <label class="form-label font-semibold">Payment Method (QR only)</label>
          <div class="mt-2">
            <button id="generateQrBtn" type="button" class="bg-pink-600 text-white px-4 py-2 rounded">Show QR Code</button>
            <button id="confirmQrPaidBtn" type="button" class="bg-green-600 text-white px-4 py-2 rounded ml-2">I have paid</button>
          </div>
          <div id="qrContainer" class="mt-3">
            <p id="qrStatus" class="text-sm text-gray-600 mt-1">No QR shown yet.</p>
            <img id="qrImage" src="" alt="QR code" class="mt-2 max-w-xs border rounded hidden" />
          </div>
        </div>

        <div class="flex items-center justify-between mt-6">
          <button id="submitBtn" type="submit" class="bg-pink-600 text-white px-4 py-2 rounded" disabled>Place Order</button>
          <a href="index.html" class="text-sm text-gray-600">Cancel</a>
        </div>
      </form>
    </div>
  </main>

  <footer class="bg-gray-800 text-white text-center py-6">
    <p>&copy; 2025 Art and Creation. All rights reserved.</p>
  </footer>

  <script>
    const products = [
      { id:1, name:'Mandala Photoframe', price:'499' },
      { id:2, name:'Customized Gift Hamper', price:'399' },
      { id:3, name:'String Art', price:'599' },
      { id:4, name:'Butterfly Keyring', price:'699' },
      { id:5, name:'Customized String Art', price:'450' },
      { id:6, name:'Ganesha Lippan Art', price:'349' },
      { id:7, name:'Dream Catcher Wall Hanging', price:'349' },
      { id:8, name:'Thread Lamp', price:'349' }
    ];

    function getQueryParam(name){ return new URLSearchParams(window.location.search).get(name); }

    function populateCheckout() {
      const id = parseInt(getQueryParam('id')||'1',10);
      const p = products.find(x=>x.id===id)||products[0];
      document.getElementById('prodName').value = p.name;
      document.getElementById('prodPrice').value = p.price;
      document.getElementById('field_product').value = p.name;
      document.getElementById('field_price').value = p.price;
    }

    async function findStaticQrForProduct(product) {
      if(!product) return null;
      const slug = product.toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_\-]/g,'');
      const candidates = [
        `images/qrcodes/${slug}.png`,
        `images/qrcodes/${slug}.jpg`,
        `qrcodes/${slug}.png`,
        `qrcodes/${slug}.jpg`,
        `images/qrcodes/default.png`
      ];
      for(const p of candidates){
        try { const r = await fetch(p,{method:'HEAD'}); if(r.ok) return p;} catch(e){}
      }
      return null;
    }

    function finalizeOrder(meta){
      const receipt='rcpt_'+Date.now();
      const order={
        receipt,
        product:meta.product,
        price:meta.price,
        name:meta.name,
        email:meta.email,
        phone:meta.phone,
        address:meta.address,
        transaction_id:meta.transaction_id||'',
        payment_status:document.getElementById('_payment_status').value,
        created_at: new Date().toISOString()
      };

      // Append hidden inputs for transaction and file
      const form = document.getElementById('checkoutForm');
      const txnInput = document.createElement('input');
      txnInput.type='hidden'; txnInput.name='transaction_id'; txnInput.value=order.transaction_id;
      form.appendChild(txnInput);

      alert('Payment confirmed and order placed successfully!');

      form.submit();
       window.location.href='thankyou.html?receipt='+encodeURIComponent(order.receipt);
    }

    document.addEventListener('DOMContentLoaded',()=>{
      populateCheckout();

      const submitBtn = document.getElementById('submitBtn');
      const requiredFields = ['buyerName','buyerEmail','buyerPhone','buyerAddress'];

      function checkFormReady() {
        const allFilled = requiredFields.every(id=>document.getElementById(id).value.trim()!=='');
        const paid = document.getElementById('_payment_status').value==='Paid';
        submitBtn.disabled = !(allFilled && paid);
      }

      requiredFields.forEach(id=>{
        document.getElementById(id).addEventListener('input', checkFormReady);
      });

      document.getElementById('generateQrBtn').addEventListener('click', async()=>{
        const product = document.getElementById('prodName').value||'';
        const qrStatus = document.getElementById('qrStatus');
        const qrImg = document.getElementById('qrImage');
        qrStatus.textContent='Searching for static QR...';
        const path = await findStaticQrForProduct(product);
        if(path){
          qrImg.src = path;
          qrImg.classList.remove('hidden');
          qrStatus.textContent='Scan the QR with your UPI app to pay.';
        } else {
          qrStatus.textContent='No static QR found for this product.';
        }
      });

      document.getElementById('confirmQrPaidBtn').addEventListener('click',()=>{
        const txn = document.getElementById('qrTxnId').value.trim();
        const fileInput = document.getElementById('paymentScreenshot');
        const hasFile = fileInput && fileInput.files && fileInput.files.length>0;
        if(!txn && !hasFile){
          alert('Please upload screenshot or enter txn ID before confirming payment.');
          return;
        }
        document.getElementById('_payment_status').value='Paid';
        alert('Payment confirmed successfully! You can now place your order.');
        checkFormReady();
      });

      document.getElementById('checkoutForm').addEventListener('submit', e=>{
        e.preventDefault();
        const allFilled = requiredFields.every(id=>document.getElementById(id).value.trim()!=='');
        const paid = document.getElementById('_payment_status').value==='Paid';
        if(!allFilled){ alert('Please fill all required fields.'); return; }
        if(!paid){ alert('Please confirm payment before submitting the order.'); return; }

        const meta={
          product:document.getElementById('prodName').value,
          price:document.getElementById('prodPrice').value,
          name:document.getElementById('buyerName').value.trim(),
          email:document.getElementById('buyerEmail').value.trim(),
          phone:document.getElementById('buyerPhone').value.trim(),
          address:document.getElementById('buyerAddress').value.trim(),
          transaction_id:document.getElementById('qrTxnId').value.trim()
        };
        finalizeOrder(meta);
      });

      checkFormReady();
    });
  </script>
</body>
</html>
