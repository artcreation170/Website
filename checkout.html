<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout - Art and Creation</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 font-sans">
  <header class="bg-white shadow">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
      <div class="flex items-center">
        <img src="logo.jpg" alt="Art and Creation Logo" class="h-12 w-12 mr-3 rounded-full object-cover bg-white" loading="lazy">
        <h1 class="text-2xl font-bold text-pink-600">Art and Creation</h1>
      </div>
      <nav>
        <a href="index.html" class="text-gray-700 px-4">Back to Shop</a>
      </nav>
    </div>
  </header>

  <main class="container mx-auto px-6 py-12">
    <div class="bg-white rounded-lg shadow-lg p-6 max-w-3xl mx-auto">
      <h2 class="text-2xl font-bold mb-4">Checkout</h2>

      <form id="checkoutForm" action="https://formsubmit.co/artcreation170@gmail.com" method="POST">
        <div id="fileProtocolNotice" class="mb-4 p-3 rounded border-l-4 border-yellow-400 bg-yellow-50 text-yellow-800 hidden">
          You're viewing this page directly as a file. FormSubmit requires the page to be served over HTTP/HTTPS.
          For local testing either run a local web server or use the fallback button below to open your mail client.
          <div class="mt-2">
            <button id="openMailFallback" type="button" class="bg-yellow-600 text-white px-3 py-1 rounded mr-2">Open Mail Fallback</button>
            <button id="howToServer" type="button" class="bg-gray-200 px-3 py-1 rounded">How to run a server</button>
          </div>
        </div>
        <input type="hidden" name="_next" value="index.html">
        <input type="hidden" name="_captcha" value="false">
        <input type="hidden" id="_subject" name="_subject" value="">
        <input type="hidden" id="_message" name="message" value="">
        <div class="mb-3">
          <label class="form-label font-semibold">Product</label>
          <input id="prodName" name="product" type="text" class="w-full border rounded px-3 py-2" readonly />
        </div>
        <div class="mb-3">
          <label class="form-label font-semibold">Price (INR)</label>
          <input id="prodPrice" name="price" type="text" class="w-full border rounded px-3 py-2" readonly />
        </div>

        <div class="mb-3">
          <label class="form-label font-semibold">Full Name</label>
          <input id="buyerName" name="name" type="text" class="w-full border rounded px-3 py-2" required />
        </div>

        <div class="mb-3">
          <label class="form-label font-semibold">Email</label>
          <input id="buyerEmail" name="email" type="email" class="w-full border rounded px-3 py-2" required />
        </div>

        <div class="mb-3">
          <label class="form-label font-semibold">Phone number</label>
          <div class="flex gap-2">
            <input id="buyerPhone" name="phone" type="tel" class="flex-1 border rounded px-3 py-2" placeholder="Enter phone (10-15 digits)" required />
            <button id="sendOtpBtn" type="button" class="bg-pink-600 text-white px-4 py-2 rounded">Send OTP</button>
            <div id="recaptcha-container" class="hidden"></div>
          </div>
          <div id="otpNote" class="text-sm text-gray-500 mt-2">OTP will be sent to the phone number (demo mode).</div>
        </div>

        <div class="mb-3">
          <label class="form-label font-semibold">Enter OTP</label>
          <div class="flex gap-2">
            <input id="otpInput" type="text" class="flex-1 border rounded px-3 py-2" placeholder="6-digit OTP" />
            <button id="verifyOtpBtn" type="button" class="bg-gray-200 px-4 py-2 rounded">Verify</button>
          </div>
          <div id="otpStatus" class="text-sm mt-2"></div>
        </div>

        <div class="mb-3">
          <label class="form-label font-semibold">Address</label>
          <textarea id="buyerAddress" name="address" class="w-full border rounded px-3 py-2" rows="3" required></textarea>
        </div>

        <!-- Payment options -->
        <div class="mb-4 border-t pt-4">
          <label class="form-label font-semibold">Payment Method</label>
          <div class="mt-2">
            <label class="inline-flex items-center mr-4">
              <input type="radio" name="payment_method_choice" value="UPI" id="payUpiRadio" class="form-radio" />
              <span class="ml-2">UPI (instant)</span>
            </label>
            <label class="inline-flex items-center">
              <input type="radio" name="payment_method_choice" value="COD" id="payCodRadio" class="form-radio" checked />
              <span class="ml-2">Cash on Delivery (COD)</span>
            </label>
          </div>

          <div id="upiPanel" class="mt-3 hidden">
            <input id="upiId" type="text" placeholder="Enter UPI ID (example@bank)" class="w-full border rounded px-3 py-2 mb-2" />
            <div class="flex gap-2">
              <button id="upiPayBtn" type="button" class="bg-pink-600 text-white px-4 py-2 rounded">Simulate UPI Pay</button>
              <div id="upiStatus" class="self-center text-sm text-gray-600"></div>
            </div>
          </div>

          <input type="hidden" id="_payment_method" name="payment_method" value="COD">
          <input type="hidden" id="_payment_status" name="payment_status" value="Pending - COD">
          <input type="hidden" id="_payment_txn" name="payment_txn" value="">
        </div>

        <div class="flex items-center justify-between">
          <button id="submitBtn" type="submit" class="bg-pink-600 text-white px-4 py-2 rounded" disabled>Place Order & Send Email</button>
          <a href="index.html" class="text-sm text-gray-600">Cancel</a>
        </div>
      </form>

      <p class="mt-4 text-sm text-gray-500">Note: OTP sending is in demo mode (no SMS provider configured). See instructions below to enable real SMS delivery (Twilio/Firebase).</p>

      <hr class="my-6" />

      <h6 class="font-semibold">Integration notes</h6>
      <ul class="text-sm text-gray-600 list-disc pl-5">
        <li>To send SMS OTPs in production, integrate a service such as Twilio or Firebase Phone Auth (requires server or Firebase config).</li>
        <li>To send email automatically from the browser use <code class="bg-gray-100 px-1 rounded">EmailJS</code>. You must replace the placeholders below with your EmailJS user/service/template IDs.</li>
      </ul>

      <div class="mt-4 p-4 border rounded bg-gray-50">
        <h6 class="font-semibold mb-2">Email delivery (free)</h6>
        <p class="text-sm text-gray-600 mb-2">This form will POST to FormSubmit.co (free simple email forwarding). No client setup required — emails will be sent to <strong>artcreation170@gmail.com</strong>. To change the destination email edit the form's `action` attribute.</p>
        <p class="text-sm text-gray-600">After you place an order you'll receive an email containing the order details and a short workflow explaining next steps (confirmation, preparation, and expected timelines). Note: FormSubmit may ask you to confirm the destination email on first use.</p>
      </div>
    </div>
  </main>

  <footer class="bg-gray-800 text-white text-center py-6">
    <p>&copy; 2025 Art and Creation. All rights reserved.</p>
  </footer>

  <!-- Using FormSubmit.co for email delivery; no client SDK required -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Firebase (compat) - replace config below with your project's values -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="js/webp-swap.js" defer></script>
  <script>
    // Firebase configuration placeholder - REPLACE with your values
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    const firebaseEnabled = firebaseConfig && firebaseConfig.apiKey && firebaseConfig.apiKey !== 'YOUR_API_KEY';
    let firebaseAuth = null;
    let confirmationResult = null;
    if (firebaseEnabled) {
      try {
        firebase.initializeApp(firebaseConfig);
        firebaseAuth = firebase.auth();
      } catch (e) {
        console.warn('Firebase init failed', e);
      }
    }
    // Copy of products data (6 products)
    const products = [
      { id:1, name:'Handmade Vase', price:'499' },
      { id:2, name:'Woven Basket', price:'399' },
      { id:3, name:'Decorative Frame', price:'599' },
      { id:4, name:'Handmade Wall Hanging', price:'699' },
      { id:5, name:'Decorative Basket', price:'450' },
      { id:6, name:'Photo Frame', price:'349' }
    ];

    // Client-side demo OTP implementation (improved local flow)
    let currentOtp = null;
    let otpVerified = false;
    const OTP_EXPIRY_MS = 5 * 60 * 1000; // 5 minutes
    const RESEND_COOLDOWN_MS = 60 * 1000; // 60 seconds
    const MAX_OTP_ATTEMPTS = 3;
    let resendTimerId = null;

    function getQueryParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    function populateCheckout() {
      const id = parseInt(getQueryParam('id') || '1', 10);
      const p = products.find(x=>x.id===id) || products[0];
      document.getElementById('prodName').value = p.name;
      document.getElementById('prodPrice').value = p.price;
    }

    function sendOtpDemo() {
      const phoneEl = document.getElementById('buyerPhone');
      const phone = (phoneEl.value || '').trim();
      const note = document.getElementById('otpNote');
      if (!/^\d{10,15}$/.test(phone.replace(/\D/g, ''))) {
        note.textContent = 'Please enter a valid phone number (10-15 digits).';
        note.className = 'text-sm text-red-600 mt-2';
        return;
      }

      // Generate random 6-digit OTP and save metadata to sessionStorage
      currentOtp = Math.floor(100000 + Math.random() * 900000).toString();
      otpVerified = false;
      const now = Date.now();
      const otpData = {
        otp: currentOtp,
        phone: phone,
        expiresAt: now + OTP_EXPIRY_MS,
        attemptsLeft: MAX_OTP_ATTEMPTS,
        lastSent: now
      };
      sessionStorage.setItem('otp_data', JSON.stringify(otpData));
      document.getElementById('otpStatus').textContent = '';

      // Demo: show OTP to user (in real app send via SMS)
      note.innerHTML = 'Demo OTP (not sent via SMS): <strong>' + currentOtp + '</strong>. It expires in 5 minutes.';
      note.className = 'text-sm text-gray-700 mt-2';
      document.getElementById('submitBtn').disabled = true;
      updateSubmitState();

      // Start resend cooldown
      startResendCooldown();
    }

    // Firebase-based OTP send (if configured)
    function sendOtpFirebase() {
      if (!firebaseEnabled || !firebaseAuth) {
        sendOtpDemo();
        return;
      }
      const phoneEl = document.getElementById('buyerPhone');
      const phoneRaw = (phoneEl.value || '').trim();
      const digits = phoneRaw.replace(/\D/g, '');
      if (!/^\d{10,15}$/.test(digits)) {
        const note = document.getElementById('otpNote');
        note.textContent = 'Please enter a valid phone number (10-15 digits).';
        note.className = 'text-sm text-red-600 mt-2';
        return;
      }
      // Normalize to E.164: if 10 digits assume +91
      let phoneE164 = phoneRaw;
      if (digits.length === 10) phoneE164 = '+91' + digits;
      else if (phoneRaw.startsWith('+')) phoneE164 = '+' + digits;
      else phoneE164 = '+' + digits;

      // Create or reuse invisible reCAPTCHA
      try {
        if (!window.recaptchaVerifier) {
          window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size: 'invisible' });
          window.recaptchaVerifier.render();
        }
        firebaseAuth.signInWithPhoneNumber(phoneE164, window.recaptchaVerifier)
          .then(function (result) {
            confirmationResult = result;
            const note = document.getElementById('otpNote');
            note.innerHTML = 'OTP sent via SMS. Please enter the code and click Verify.';
            note.className = 'text-sm text-gray-700 mt-2';
            document.getElementById('submitBtn').disabled = true;
            updateSubmitState();
          }).catch(function (err) {
            console.error('Firebase SMS error', err);
            const note = document.getElementById('otpNote');
            note.textContent = 'Failed to send OTP via Firebase: ' + (err && err.message ? err.message : err);
            note.className = 'text-sm text-red-600 mt-2';
            // fallback to demo
            // sendOtpDemo();
          });
      } catch (e) {
        console.error(e);
        sendOtpDemo();
      }
    }

    function verifyOtp() {
      const entered = (document.getElementById('otpInput').value || '').trim();
      const status = document.getElementById('otpStatus');
      const otpRaw = sessionStorage.getItem('otp_data');
      if (!otpRaw) {
        status.textContent = 'Please request an OTP first.';
        status.className = 'text-sm text-red-600 mt-1';
        return;
      }
      const otpData = JSON.parse(otpRaw);
      const now = Date.now();
      if (now > otpData.expiresAt) {
        sessionStorage.removeItem('otp_data');
        currentOtp = null;
        status.textContent = 'OTP expired. Request a new one.';
        status.className = 'text-sm text-red-600 mt-1';
        document.getElementById('submitBtn').disabled = true;
        return;
      }
      if (otpData.attemptsLeft <= 0) {
        status.textContent = 'No attempts left. Request a new OTP.';
        status.className = 'text-sm text-red-600 mt-1';
        document.getElementById('submitBtn').disabled = true;
        return;
      }
      if (entered === otpData.otp) {
        otpVerified = true;
        status.textContent = 'Phone verified ✓';
        status.className = 'text-sm text-green-600 mt-1';
        sessionStorage.removeItem('otp_data');
        currentOtp = null;
        clearResendCooldown();
        updateSubmitState();
      } else {
        otpData.attemptsLeft = Math.max(0, otpData.attemptsLeft - 1);
        sessionStorage.setItem('otp_data', JSON.stringify(otpData));
        otpVerified = false;
        status.textContent = 'Incorrect OTP. Attempts left: ' + otpData.attemptsLeft;
        status.className = 'text-sm text-red-600 mt-1';
        updateSubmitState();
      }
    }

    // Verify OTP when using Firebase
    function verifyOtpFirebase() {
      const code = (document.getElementById('otpInput').value || '').trim();
      const status = document.getElementById('otpStatus');
      if (!confirmationResult) {
        status.textContent = 'No OTP request found. Please request an OTP first.';
        status.className = 'text-sm text-red-600 mt-1';
        return;
      }
      confirmationResult.confirm(code).then(function (result) {
        otpVerified = true;
        status.textContent = 'Phone verified ✓';
        status.className = 'text-sm text-green-600 mt-1';
        confirmationResult = null;
        clearResendCooldown();
        updateSubmitState();
      }).catch(function (err) {
        console.error('Verification failed', err);
        otpVerified = false;
        status.textContent = 'Incorrect OTP or verification failed.';
        status.className = 'text-sm text-red-600 mt-1';
        updateSubmitState();
      });
    }

    function startResendCooldown() {
      const sendBtn = document.getElementById('sendOtpBtn');
      const note = document.getElementById('otpNote');
      if (!sendBtn) return;
      sendBtn.disabled = true;
      const raw = sessionStorage.getItem('otp_data');
      if (!raw) return;
      const otpData = JSON.parse(raw);
      const expiresAt = otpData.lastSent + RESEND_COOLDOWN_MS;
      function tick() {
        const now = Date.now();
        const remaining = Math.max(0, Math.ceil((expiresAt - now) / 1000));
        if (remaining <= 0) {
          sendBtn.disabled = false;
          note.className = 'text-sm text-gray-700 mt-2';
          note.textContent = 'You can request a new OTP.';
          clearInterval(resendTimerId);
          resendTimerId = null;
        } else {
          sendBtn.textContent = 'Resend OTP (' + remaining + 's)';
        }
      }
      // immediate tick and interval
      tick();
      clearInterval(resendTimerId);
      resendTimerId = setInterval(tick, 1000);
    }

    function clearResendCooldown() {
      const sendBtn = document.getElementById('sendOtpBtn');
      const note = document.getElementById('otpNote');
      if (resendTimerId) {
        clearInterval(resendTimerId);
        resendTimerId = null;
      }
      if (sendBtn) {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send OTP';
      }
      if (note) {
        note.className = 'text-sm text-gray-500 mt-2';
        note.textContent = 'OTP will be sent to the phone number (demo mode).';
      }
    }

    // Payment simulation state
    let paymentMethod = 'COD';
    let paymentCompleted = false;

    function setPaymentMethod(method) {
      paymentMethod = method;
      const upiPanel = document.getElementById('upiPanel');
      const subjectInput = document.getElementById('_subject');
      if (upiPanel) upiPanel.classList.toggle('hidden', method !== 'UPI');
      // reset UPI state when switching
      if (method !== 'UPI') {
        paymentCompleted = false;
        const upiStatus = document.getElementById('upiStatus');
        if (upiStatus) upiStatus.textContent = '';
      }
      const payMethodHidden = document.getElementById('_payment_method');
      const payStatusHidden = document.getElementById('_payment_status');
      if (payMethodHidden) payMethodHidden.value = method;
      if (payStatusHidden) payStatusHidden.value = method === 'COD' ? 'Pending - COD' : 'Pending - UPI';
      updateSubmitState();
    }

    function simulateUpiPay() {
      const upiId = (document.getElementById('upiId').value || '').trim();
      const upiStatus = document.getElementById('upiStatus');
      if (!upiId || !/^[\w.\-]{2,}@\w{2,}$/.test(upiId)) {
        if (upiStatus) {
          upiStatus.textContent = 'Enter a valid UPI ID (example@bank).';
          upiStatus.className = 'text-sm text-red-600';
        }
        paymentCompleted = false;
        return;
      }
      // Simulate a successful payment: generate a fake txn id
      const txn = 'TXN' + Date.now().toString().slice(-6);
      paymentCompleted = true;
      const payMethodHidden = document.getElementById('_payment_method');
      const payStatusHidden = document.getElementById('_payment_status');
      const payTxnHidden = document.getElementById('_payment_txn');
      if (payMethodHidden) payMethodHidden.value = 'UPI';
      if (payStatusHidden) payStatusHidden.value = 'Success';
      if (payTxnHidden) payTxnHidden.value = txn;
      if (upiStatus) {
        upiStatus.textContent = `Payment successful — txn ${txn}`;
        upiStatus.className = 'text-sm text-green-600';
      }
      updateSubmitState();
    }

    // Form readiness: only enable submit when OTP verified, required fields filled, and payment completed when required
    function isFormReady() {
      try {
        if (!otpVerified) return false;
        const name = (document.getElementById('buyerName').value || '').trim();
        const phone = (document.getElementById('buyerPhone').value || '').trim();
        const address = (document.getElementById('buyerAddress').value || '').trim();
        if (!name || !address) return false;
        if (!/^\d{10,15}$/.test(phone.replace(/\D/g, ''))) return false;
        const method = (document.getElementById('_payment_method') && document.getElementById('_payment_method').value) || 'COD';
        if (method === 'UPI' && !paymentCompleted) return false;
        return true;
      } catch (e) {
        return false;
      }
    }

    function updateSubmitState() {
      const submitBtn = document.getElementById('submitBtn');
      if (!submitBtn) return;
      const ready = isFormReady();
      submitBtn.disabled = !ready;
    }


    document.addEventListener('DOMContentLoaded', () => {
      populateCheckout();

      // If the page is opened via file:// show a helpful notice and provide a mailto fallback
      if (location.protocol === 'file:') {
        const notice = document.getElementById('fileProtocolNotice');
        if (notice) notice.classList.remove('hidden');

        // Fallback: open user's mail client with order details (for local testing only)
        document.getElementById('openMailFallback').addEventListener('click', function(){
          const product = document.getElementById('prodName').value || '';
          const price = document.getElementById('prodPrice').value || '';
          const name = (document.getElementById('buyerName').value || '').trim();
          const phone = (document.getElementById('buyerPhone').value || '').trim();
          const address = (document.getElementById('buyerAddress').value || '').trim();
          const subject = `New Order: ${product} — ${name || 'Local Test'}`;
          const body = `Order Details:\nProduct: ${product}\nPrice: INR ${price}\nName: ${name}\nPhone: ${phone}\nAddress: ${address}`;
          // Open mail client
          window.location.href = 'mailto:artcreation170@gmail.com?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
        });

        document.getElementById('howToServer').addEventListener('click', function(){
          alert('Run a local server and open http://localhost:8000 in your browser.\nFor example, run:\n\npython -m http.server 8000-\n\nOr use VS Code Live Server extension.');
        });

        // Prevent default FormSubmit submission when running as file:// and instead use mailto fallback
        const form = document.getElementById('checkoutForm');
        if (form) {
          form.addEventListener('submit', function(e){
            // Allow the mailto fallback via the button; if user directly clicks submit show guidance
            e.preventDefault();
            alert('This page is opened as a file. FormSubmit will not work. Use the "Open Mail Fallback" button or serve the page via a local web server (see instructions).');
            return false;
          });
        }
      }

      // OTP handlers (use Firebase if configured)
      document.getElementById('sendOtpBtn').addEventListener('click', function(){
        if (firebaseEnabled) sendOtpFirebase(); else sendOtpDemo();
      });
      document.getElementById('verifyOtpBtn').addEventListener('click', function(){
        if (firebaseEnabled) verifyOtpFirebase(); else verifyOtp();
      });

      // Input listeners to update submit state
      const nameEl = document.getElementById('buyerName');
      const phoneEl = document.getElementById('buyerPhone');
      const addrEl = document.getElementById('buyerAddress');
      const upiIdEl = document.getElementById('upiId');
      if (nameEl) nameEl.addEventListener('input', updateSubmitState);
      if (phoneEl) phoneEl.addEventListener('input', updateSubmitState);
      if (addrEl) addrEl.addEventListener('input', updateSubmitState);
      if (upiIdEl) upiIdEl.addEventListener('input', updateSubmitState);

      // Payment option handlers
      const upiRadio = document.getElementById('payUpiRadio');
      const codRadio = document.getElementById('payCodRadio');
      const upiPayBtn = document.getElementById('upiPayBtn');
      if (upiRadio) upiRadio.addEventListener('change', () => setPaymentMethod('UPI'));
      if (codRadio) codRadio.addEventListener('change', () => setPaymentMethod('COD'));
      if (upiPayBtn) upiPayBtn.addEventListener('click', simulateUpiPay);

      // initialize payment UI according to default selection
      if (document.getElementById('payUpiRadio') && document.getElementById('payUpiRadio').checked) {
        setPaymentMethod('UPI');
      } else {
        setPaymentMethod('COD');
      }

      document.getElementById('checkoutForm').addEventListener('submit', function(e){
        e.preventDefault();
        if (!otpVerified) {
          alert('Please verify your phone number with OTP before submitting.');
          return;
        }
        const data = {
          product: document.getElementById('prodName').value,
          price: document.getElementById('prodPrice').value,
          name: document.getElementById('buyerName').value.trim(),
          email: (document.getElementById('buyerEmail') && document.getElementById('buyerEmail').value.trim()) || '',
          phone: document.getElementById('buyerPhone').value.trim(),
          address: document.getElementById('buyerAddress').value.trim()
        };

        // Basic validation
        if (!data.name || !/^\d{10,15}$/.test(data.phone.replace(/\D/g, '')) || !data.address) {
          alert('Please fill in all required fields correctly.');
          return;
        }

        // Build an informative subject and message payload for the email
        const subjectInput = document.getElementById('_subject');
        const messageInput = document.getElementById('_message');
        const subjectText = `New Order: ${data.product} — ${data.name}`;
        const workflow = `Workflow:\n1) We received your order and will confirm availability within 24 hours.\n2) Once confirmed we prepare the item (1-3 business days).\n3) You'll receive shipment details and tracking when dispatched.\n4) Contact artcreation170@gmail.com for support.`;
        const messageText = `Order Details:\nProduct: ${data.product}\nPrice: INR ${data.price}\nName: ${data.name}\nEmail: ${data.email}\nPhone: ${data.phone}\nAddress: ${data.address}\n\n${workflow}`;
        if (subjectInput) subjectInput.value = subjectText;
        if (messageInput) messageInput.value = messageText;

        // Ensure payment state is valid
        const hiddenMethod = (document.getElementById('_payment_method') && document.getElementById('_payment_method').value) || 'COD';
        const hiddenStatusEl = document.getElementById('_payment_status');
        const hiddenStatus = hiddenStatusEl ? hiddenStatusEl.value : (hiddenMethod === 'COD' ? 'Pending - COD' : 'Pending');
        if (hiddenMethod === 'UPI' && !paymentCompleted) {
          alert('Please complete the UPI payment (click Simulate UPI Pay) before placing the order.');
          return;
        }

        // Append payment info to message and hidden fields
        const payTxn = (document.getElementById('_payment_txn') && document.getElementById('_payment_txn').value) || '';
        const paymentSummary = `Payment Method: ${hiddenMethod}\nPayment Status: ${hiddenStatus}${payTxn ? '\nTxn: ' + payTxn : ''}`;
        const finalMessage = messageText + '\n\n' + paymentSummary;
        if (messageInput) messageInput.value = finalMessage;

        // Notify the user and submit the form to FormSubmit.co which will forward the email.
        alert('Order submitted. You will receive an email with order details and next steps shortly.');
        document.getElementById('checkoutForm').submit();
      });
    });
  </script>
</body>
</html>
